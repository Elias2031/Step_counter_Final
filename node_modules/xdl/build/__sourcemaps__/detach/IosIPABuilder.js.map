{"version":3,"sources":["detach/IosIPABuilder.js"],"names":["createIPABuilder","logger","_logger","withFields","buildPhase","buildParams","async","provisioningProfilePath","clientBuild","await","copyProvisioningProfileToHomedir","appUUID","info","plistData","readCMSMessage","codeSignIdentity","utils","ensureCertificateValid","exportMethod","resolveExportMethod","exportOptionsPlistPath","path","join","provisionDir","exportOptionsData","bundleIdentifier","provisioningProfileUUID","UUID","teamID","writeExportOptionsPlistFile","unsignedIpaPath","buildDir","ipaBuilderArgs","ipaPath","workspace","archivePath","outputPath","keychainPath","buildIPA","generatedEntitlementsPath","appDir","createEntitlementsFile","resignIPA","entitlementsPath","sourceIpaPath","destIpaPath","uploadPath","build","fs","remove","getProvisioningProfilePath","err","error","cleanup","mkdirp","getProvisioningProfileDirPath","newProvisioningProfilePath","copy","output","spawnAsyncThrowError","stdio","plistRaw","_","attempt","plist","parse","isError","Error","message","workingDir","process","env","TURTLE_WORKING_DIR_PATH","os","homedir"],"mappings":"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","file":"../../detach/IosIPABuilder.js","sourcesContent":["import _ from 'lodash';\nimport os from 'os';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport plist from 'plist';\n\nimport _logger from './Logger';\nimport { spawnAsyncThrowError } from './ExponentTools';\nimport * as utils from './IosUtils';\n\nconst logger = _logger.withFields({ buildPhase: 'building and signing IPA' });\n\nexport default function createIPABuilder(buildParams) {\n  const { appUUID, keychainPath, bundleIdentifier, teamID } = buildParams;\n  const workingDir = process.env.TURTLE_WORKING_DIR_PATH;\n  const workspace = path.join(\n    workingDir,\n    'shellAppWorkspaces',\n    'ios',\n    'default',\n    'ExpoKitApp.xcworkspace'\n  );\n  const appDir = path.join('/private/tmp/turtle', appUUID);\n  const buildDir = path.join(appDir, 'build');\n  const provisionDir = path.join(appDir, 'provisioning');\n  const outputPath = path.join(appDir, 'archive.xcarchive');\n  const uploadPath = path.join(buildDir, 'archive.ipa');\n\n  async function build() {\n    const { provisioningProfilePath, clientBuild } = buildParams;\n\n    await copyProvisioningProfileToHomedir(provisioningProfilePath, appUUID);\n    logger.info('provisioning profile copied to home directory');\n\n    const plistData = await readCMSMessage(provisioningProfilePath);\n    logger.info('done retrieving provisioning profile data');\n\n    logger.info('checking if teamID is present in keychain and that certificate is valid...');\n    const codeSignIdentity = await utils.ensureCertificateValid(buildParams);\n    logger.info('ensured certificate is valid');\n\n    logger.info('writing export-options.plist file...');\n    const exportMethod = utils.resolveExportMethod(plistData);\n    const exportOptionsPlistPath = path.join(provisionDir, 'export-options.plist');\n    const exportOptionsData = {\n      bundleIdentifier,\n      provisioningProfileUUID: plistData.UUID,\n      exportMethod,\n      teamID,\n    };\n    await utils.writeExportOptionsPlistFile(exportOptionsPlistPath, exportOptionsData);\n    logger.info('created export-options.plist file');\n\n    logger.info('generating IPA...');\n    const unsignedIpaPath = path.join(buildDir, `${appUUID}-unsigned.ipa`);\n    const ipaBuilderArgs = {\n      ipaPath: unsignedIpaPath,\n      workspace,\n      archivePath: outputPath,\n      codeSignIdentity,\n      exportOptionsPlistPath,\n      plistData,\n      keychainPath,\n      exportMethod,\n    };\n    await utils.buildIPA(ipaBuilderArgs, buildParams, clientBuild);\n    logger.info('generated IPA');\n\n    logger.info('creating entitlements file...');\n    const generatedEntitlementsPath = path.join(appDir, 'generatedEntitlements.entitlements');\n    await utils.createEntitlementsFile({\n      generatedEntitlementsPath,\n      plistData,\n      archivePath: outputPath,\n    });\n    logger.info('created entitlements file');\n\n    logger.info('resigning IPA...');\n    await utils.resignIPA(\n      {\n        codeSignIdentity,\n        entitlementsPath: generatedEntitlementsPath,\n        provisioningProfilePath,\n        sourceIpaPath: unsignedIpaPath,\n        destIpaPath: uploadPath,\n        keychainPath,\n      },\n      buildParams\n    );\n    logger.info('resigned IPA');\n  }\n\n  async function cleanup() {\n    try {\n      await fs.remove(getProvisioningProfilePath(appUUID));\n    } catch (err) {\n      logger.error('failed to perform cleanup, error:', err);\n    }\n  }\n\n  async function copyProvisioningProfileToHomedir(provisioningProfilePath, appUUID) {\n    await fs.mkdirp(getProvisioningProfileDirPath());\n    const newProvisioningProfilePath = getProvisioningProfilePath(appUUID);\n    await fs.copy(provisioningProfilePath, newProvisioningProfilePath);\n  }\n\n  async function readCMSMessage(provisioningProfilePath) {\n    const { output } = await spawnAsyncThrowError(\n      'security',\n      ['cms', '-D', '-i', provisioningProfilePath],\n      {\n        stdio: 'pipe',\n      }\n    );\n    const plistRaw = output.join('');\n    const plistData = _.attempt(plist.parse, plistRaw);\n    if (_.isError(plistData)) {\n      throw new Error(`Error when parsing plist: ${plistData.message}`);\n    }\n    return plistData;\n  }\n\n  const getProvisioningProfileDirPath = () =>\n    path.join(os.homedir(), 'Library/MobileDevice/Provisioning Profiles');\n\n  const getProvisioningProfilePath = appUUID =>\n    path.join(getProvisioningProfileDirPath(), `${appUUID}.mobileprovision`);\n\n  return { build, cleanup };\n}\n"],"sourceRoot":"/xdl@50.0.0/src"}
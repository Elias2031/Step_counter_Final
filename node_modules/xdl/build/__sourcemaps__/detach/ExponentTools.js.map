{"version":3,"sources":["detach/ExponentTools.js"],"names":["async","url","headers","buildPhaseLogger","logger","withFields","buildPhase","requestOptions","replace","response","await","request","responseBody","body","info","let","manifest","JSON","parse","e","Error","getManifestAsync","args","length","spawnAsyncQuiet","stdio","cwd","process","options","pipeToLogger","promise","child","pipeOutputToLogger","loggerFields","stdoutOnly","spawnAsyncThrowError","error","message","spawnAsync","filename","transform","fileString","fs","readFile","newFileString","writeFile","transformFileContentsAsync","inMemoryManifest","locales","undefined","lang","path","Object","entries","s","ErrorCode","INVALID_JSON","stringify","getResolvedLocalesAsync","regex","file","toString","regexFileAsync","startRegex","endRegex","lines","split","filteredLines","inDeleteRange","i","match","push","join","deleteLinesInFileAsync","Request","defaults","resolveWithFullResponse","_getFilesizeInBytes","stats","statSync","fileSizeInBytes","parseSdkMajorVersion","expSdkVersion","Infinity","sdkMajorVersion","versionComponents","map","number","parseInt","_","saveUrlToPathAsync","Promise","resolve","reject","stream","createWriteStream","on","pipeRequest","pipe","saveImageToPathAsync","projectRoot","pathOrURL","outPath","localPath","existsSync","createReadStream","createSpawner","command","lastArg","last","optionsFromArg","isObject","pop","manifestUsesSplashApi","platform","splash","ios","android","rimrafDontThrow","directory","rimraf","sync","warn","isDirectory","dir"],"mappings":"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","file":"../../detach/ExponentTools.js","sourcesContent":["// Copyright 2015-present 650 Industries. All rights reserved.\n\n'use strict';\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport Request from 'request-promise-native';\n// `request-promise-native` discourages using pipe. Noticed some issues with\n// error handling so when using pipe use the original request lib instead.\nimport pipeRequest from 'request';\nimport rimraf from 'rimraf';\nimport spawnAsyncQuiet from '@expo/spawn-async';\nimport _ from 'lodash';\n\nimport logger, { pipeOutputToLogger } from './Logger';\nimport XDLError from '../XDLError';\nimport ErrorCode from '../ErrorCode';\n\nconst request = Request.defaults({\n  resolveWithFullResponse: true,\n});\n\nfunction _getFilesizeInBytes(path) {\n  let stats = fs.statSync(path);\n  let fileSizeInBytes = stats['size'];\n  return fileSizeInBytes;\n}\n\nfunction parseSdkMajorVersion(expSdkVersion) {\n  // We assume that the unversioned SDK is the latest\n  if (expSdkVersion === 'UNVERSIONED') {\n    return Infinity;\n  }\n\n  let sdkMajorVersion = 0;\n  try {\n    let versionComponents = expSdkVersion.split('.').map(number => parseInt(number, 10));\n    sdkMajorVersion = versionComponents[0];\n  } catch (_) {}\n  return sdkMajorVersion;\n}\n\nfunction saveUrlToPathAsync(url, path) {\n  return new Promise(function(resolve, reject) {\n    let stream = fs.createWriteStream(path);\n    stream.on('close', () => {\n      if (_getFilesizeInBytes(path) < 10) {\n        throw new Error(`{filename} is too small`);\n      }\n      resolve();\n    });\n    stream.on('error', reject);\n    pipeRequest(url).pipe(stream);\n  });\n}\n\nfunction saveImageToPathAsync(projectRoot, pathOrURL, outPath) {\n  const localPath = path.resolve(projectRoot, pathOrURL);\n  return new Promise(function(resolve, reject) {\n    let stream = fs.createWriteStream(outPath);\n    stream.on('close', () => {\n      if (_getFilesizeInBytes(outPath) < 10) {\n        throw new Error(`{filename} is too small`);\n      }\n      resolve();\n    });\n    stream.on('error', reject);\n    if (fs.existsSync(localPath)) {\n      fs.createReadStream(localPath).pipe(stream);\n    } else {\n      pipeRequest(pathOrURL).pipe(stream);\n    }\n  });\n}\n\nasync function getManifestAsync(url, headers) {\n  const buildPhaseLogger = logger.withFields({ buildPhase: 'reading manifest' });\n  const requestOptions = {\n    url: url.replace('exp://', 'http://') + '/index.exp',\n    headers,\n  };\n\n  const response = await request(requestOptions);\n  const responseBody = response.body;\n  buildPhaseLogger.info('Using manifest:', responseBody);\n  let manifest;\n  try {\n    manifest = JSON.parse(responseBody);\n  } catch (e) {\n    throw new Error(`Unable to parse manifest: ${e}`);\n  }\n\n  return manifest;\n}\n\nasync function spawnAsyncThrowError(...args) {\n  if (args.length === 2) {\n    return spawnAsyncQuiet(args[0], args[1], {\n      stdio: 'inherit',\n      cwd: process.cwd(),\n    });\n  } else {\n    const options = args[2];\n    if (options.pipeToLogger) {\n      options.stdio = 'pipe';\n      options.cwd = options.cwd || process.cwd();\n    }\n    const promise = spawnAsyncQuiet(...args);\n    if (options.pipeToLogger && promise.child) {\n      pipeOutputToLogger(promise.child, options.loggerFields, options.stdoutOnly);\n    }\n    return promise;\n  }\n}\n\nasync function spawnAsync(...args) {\n  try {\n    return await spawnAsyncThrowError(...args);\n  } catch (e) {\n    logger.error(e.message);\n  }\n}\n\nfunction createSpawner(buildPhase, logger) {\n  return (command, ...args) => {\n    const lastArg = _.last(args);\n    const optionsFromArg = _.isObject(lastArg) ? args.pop() : {};\n\n    const options = { ...optionsFromArg, pipeToLogger: true };\n    if (buildPhase) {\n      options.loggerFields = options.loggerFields ? options.loggerFields : {};\n      options.loggerFields = { ...options.loggerFields, buildPhase };\n    }\n\n    if (logger) {\n      logger.info('Executing command:', command, ...args);\n    }\n    return spawnAsyncThrowError(command, args, options);\n  };\n}\n\nasync function transformFileContentsAsync(filename, transform) {\n  let fileString = await fs.readFile(filename, 'utf8');\n  let newFileString = transform(fileString);\n  if (newFileString !== null) {\n    await fs.writeFile(filename, newFileString);\n  }\n}\n\nfunction manifestUsesSplashApi(manifest, platform) {\n  if (platform === 'ios') {\n    return manifest.splash || (manifest.ios && manifest.ios.splash);\n  }\n  if (platform === 'android') {\n    return manifest.splash || (manifest.android && manifest.android.splash);\n  }\n  return false;\n}\n\nfunction rimrafDontThrow(directory) {\n  try {\n    rimraf.sync(directory);\n  } catch (e) {\n    logger.warn(\n      `There was an issue cleaning up, but your project should still work. You may need to manually remove ${directory}. (${e})`\n    );\n  }\n}\n\nfunction isDirectory(dir) {\n  try {\n    if (fs.statSync(dir).isDirectory()) {\n      return true;\n    }\n\n    return false;\n  } catch (e) {\n    return false;\n  }\n}\n\nasync function getResolvedLocalesAsync(inMemoryManifest) {\n  const locales = {};\n  if (inMemoryManifest.locales !== undefined) {\n    for (const [lang, path] of Object.entries(inMemoryManifest.locales)) {\n      const s = await fs.readFile(path, 'utf8');\n      try {\n        locales[lang] = JSON.parse(s);\n      } catch (e) {\n        throw new XDLError(ErrorCode.INVALID_JSON, JSON.stringify(e));\n      }\n    }\n  }\n  return locales;\n}\n\nasync function regexFileAsync(regex, replace, filename) {\n  let file = await fs.readFile(filename);\n  let fileString = file.toString();\n  await fs.writeFile(filename, fileString.replace(regex, replace));\n}\n\n// Matches sed /d behavior\nasync function deleteLinesInFileAsync(startRegex, endRegex, filename) {\n  let file = await fs.readFile(filename);\n  let fileString = file.toString();\n  let lines = fileString.split(/\\r?\\n/);\n  let filteredLines = [];\n  let inDeleteRange = false;\n  for (let i = 0; i < lines.length; i++) {\n    if (lines[i].match(startRegex)) {\n      inDeleteRange = true;\n    }\n\n    if (!inDeleteRange) {\n      filteredLines.push(lines[i]);\n    }\n\n    if (inDeleteRange && lines[i].match(endRegex)) {\n      inDeleteRange = false;\n    }\n  }\n  await fs.writeFile(filename, filteredLines.join('\\n'));\n}\n\nexport {\n  isDirectory,\n  parseSdkMajorVersion,\n  saveUrlToPathAsync,\n  saveImageToPathAsync,\n  getManifestAsync,\n  rimrafDontThrow,\n  spawnAsyncThrowError,\n  spawnAsync,\n  transformFileContentsAsync,\n  manifestUsesSplashApi,\n  getResolvedLocalesAsync,\n  regexFileAsync,\n  deleteLinesInFileAsync,\n  createSpawner,\n};\n"],"sourceRoot":"/xdl@50.0.0/src"}
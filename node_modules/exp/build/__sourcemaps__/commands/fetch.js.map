{"version":3,"sources":["commands/fetch.js"],"names":["projectDir","temporary","getPublishInfoAsync","args","username","remotePackageName","experienceName","remoteFullPackageName","outputFile","resolve","credentialMetadata","platform","getCredentialsForPlatform","credentials","Error","keystore","keystorePassword","keyAlias","keystoreAlias","keyPassword","storeBuf","Buffer","from","writeFileSync","writeKeystore","exportCertAsync","keystoreFile","certFile","program","command","description","asyncActionProjectDir","options","bundleIdentifier","bundleIdentifierIOS","distOutputFile","pushOutputFile","certP12","certPassword","certPrivateSigningKey","pushP12","pushPassword","pushPrivateSigningKey","provisioningProfile","teamId","undefined","keyPath","p","bold","replace","data","readFileSync","googleHash","createHash","update","digest","toUpperCase","fbHash","code","warn","stdout","stderr","error","unlinkSync","err"],"mappings":"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","file":"../../commands/fetch.js","sourcesContent":["/**\n * @flow\n */\n\nimport chalk from 'chalk';\nimport fs from 'fs';\nimport path from 'path';\nimport { Credentials, Exp } from 'xdl';\nimport crypto from 'crypto';\nimport spawnAsync from '@expo/spawn-async';\nimport log from '../log';\n\nfunction exportCertAsync(keystoreFile, keystorePassword, keyAlias, certFile) {\n  return spawnAsync('keytool', [\n    '-exportcert',\n    '-keystore',\n    keystoreFile,\n    '-storepass',\n    keystorePassword,\n    '-alias',\n    keyAlias,\n    '-file',\n    certFile,\n    '-noprompt',\n    '-storetype',\n    'JKS',\n  ]);\n}\n\nasync function writeKeystore(projectDir, temporary = false) {\n  const {\n    args: { username, remotePackageName, remoteFullPackageName: experienceName },\n  } = await Exp.getPublishInfoAsync(projectDir);\n\n  const outputFile = path.resolve(projectDir, `${remotePackageName}${temporary ? '.tmp' : ''}.jks`);\n  const credentialMetadata = { username, experienceName, platform: 'android' };\n\n  log(`Retreiving Android keystore for ${experienceName}`);\n  const credentials: ?AndroidCredentials = await Credentials.getCredentialsForPlatform(\n    credentialMetadata\n  );\n\n  if (!credentials) {\n    throw new Error(\n      'Unable to fetch credentials for this project. Are you sure they exist? Did you build a standalone Android app?'\n    );\n  }\n\n  const { keystore, keystorePassword, keystoreAlias: keyAlias, keyPassword } = credentials;\n  const storeBuf = Buffer.from(keystore, 'base64');\n\n  if (!temporary) {\n    log(`Writing keystore to ${outputFile}...`);\n  }\n  fs.writeFileSync(outputFile, storeBuf);\n\n  return {\n    outputFile,\n    keystorePassword,\n    keyPassword,\n    keyAlias,\n  };\n}\n\nexport default (program: any) => {\n  program\n    .command('fetch:ios:certs [project-dir]')\n    .description(\n      `Fetch this project's iOS certificates and provisioning profile. Writes certificates to PROJECT_DIR/PROJECT_NAME_(dist|push).p12 and prints passwords to stdout.`\n    )\n    .asyncActionProjectDir(async (projectDir, options) => {\n      const {\n        args: {\n          username,\n          remotePackageName,\n          remoteFullPackageName: experienceName,\n          bundleIdentifierIOS: bundleIdentifier,\n        },\n      } = await Exp.getPublishInfoAsync(projectDir);\n\n      let distOutputFile = path.resolve(projectDir, `${remotePackageName}_dist.p12`);\n      let pushOutputFile = path.resolve(projectDir, `${remotePackageName}_push.p12`);\n\n      const credentialMetadata = { username, experienceName, platform: 'ios', bundleIdentifier };\n\n      log(`Retreiving iOS credentials for ${experienceName}`);\n\n      try {\n        const {\n          certP12,\n          certPassword,\n          certPrivateSigningKey,\n          pushP12,\n          pushPassword,\n          pushPrivateSigningKey,\n          provisioningProfile,\n          teamId,\n        } = await Credentials.getCredentialsForPlatform(credentialMetadata);\n        // if undefines because some people might have pre-local-auth as default credentials.\n        if (teamId !== undefined) {\n          log(`These credentials are associated with Apple Team ID: ${teamId}`);\n        }\n        log(`Writing distribution cert to ${distOutputFile}...`);\n        fs.writeFileSync(distOutputFile, Buffer.from(certP12, 'base64'));\n        if (certPrivateSigningKey !== undefined) {\n          let keyPath = path.resolve(projectDir, `${remotePackageName}_dist_cert_private.key`);\n          fs.writeFileSync(keyPath, certPrivateSigningKey);\n        }\n        log('Done writing distribution cert credentials to disk.');\n        log(`Writing push cert to ${pushOutputFile}...`);\n        fs.writeFileSync(pushOutputFile, Buffer.from(pushP12, 'base64'));\n        if (pushPrivateSigningKey !== undefined) {\n          let keyPath = path.resolve(projectDir, `${remotePackageName}_push_cert_private.key`);\n          fs.writeFileSync(keyPath, pushPrivateSigningKey);\n        }\n        log('Done writing push cert credentials to disk.');\n        if (provisioningProfile !== undefined) {\n          let p = path.resolve(projectDir, `${remotePackageName}.mobileprovision`);\n          log(`Writing provisioning profile to ${p}...`);\n          fs.writeFileSync(p, Buffer.from(provisioningProfile, 'base64'));\n          log('Done writing provisioning profile to disk');\n        }\n        log(`Save these important values as well:\n\nDistribution p12 password: ${chalk.bold(certPassword)}\nPush p12 password:         ${chalk.bold(pushPassword)}\n`);\n      } catch (e) {\n        throw new Error('Unable to fetch credentials for this project. Are you sure they exist?');\n      }\n\n      log('All done!');\n    }, true);\n\n  program\n    .command('fetch:android:keystore [project-dir]')\n    .description(\n      \"Fetch this project's Android keystore. Writes keystore to PROJECT_DIR/PROJECT_NAME.jks and prints passwords to stdout.\"\n    )\n    .asyncActionProjectDir(async (projectDir, options) => {\n      const { keystorePassword, keyPassword, keyAlias } = await writeKeystore(projectDir);\n\n      log('Done writing keystore to disk.');\n      log(`Save these important values as well:\n\nKeystore password: ${chalk.bold(keystorePassword)}\nKey alias:         ${chalk.bold(keyAlias)}\nKey password:      ${chalk.bold(keyPassword)}\n`);\n\n      log('All done!');\n    }, true);\n\n  program\n    .command('fetch:android:hashes [project-dir]')\n    .description(\n      \"Fetch this project's Android key hashes needed to setup Google/Facebook authentication.\"\n    )\n    .asyncActionProjectDir(async (projectDir, options) => {\n      const { outputFile, keystorePassword, keyAlias } = await writeKeystore(projectDir, true);\n      const certFile = outputFile.replace('jks', 'cer');\n      try {\n        await exportCertAsync(outputFile, keystorePassword, keyAlias, certFile);\n        const data = fs.readFileSync(certFile);\n        const googleHash = crypto\n          .createHash('sha1')\n          .update(data)\n          .digest('hex')\n          .toUpperCase();\n        const fbHash = crypto\n          .createHash('sha1')\n          .update(data)\n          .digest('base64');\n        log(`Google Certificate Fingerprint:  ${googleHash.replace(/(.{2}(?!$))/g, '$1:')}`);\n        log(`Google Certificate Hash:         ${googleHash}`);\n        log(`Facebook Key Hash:               ${fbHash}`);\n      } catch (err) {\n        if (err.code === 'ENOENT') {\n          log.warn('Are you sure you have keytool installed?');\n          log('keytool is part of openJDK: http://openjdk.java.net/');\n          log('Also make sure that keytool is in your PATH after installation.');\n        }\n        if (err.stdout) {\n          log(err.stdout);\n        }\n        if (err.stderr) {\n          log.error(err.stderr);\n        }\n        throw err;\n      } finally {\n        try {\n          fs.unlinkSync(certFile);\n        } catch (err) {\n          if (err.code !== 'ENOENT') {\n            log.error(err);\n          }\n        }\n        try {\n          fs.unlinkSync(outputFile);\n        } catch (err) {\n          if (err.code !== 'ENOENT') {\n            log.error(err);\n          }\n        }\n      }\n\n      log('All done!');\n    }, true);\n};\n"],"sourceRoot":"/exp@54.0.1/src"}
{"version":3,"sources":["commands/build/AndroidBuilder.js"],"names":["AndroidBuilder","checkStatus","validateProject","collectAndValidateCredentials","ensureReleaseExists","publishedExpIds","build","getPublishInfoAsync","projectDir","args","username","remotePackageName","experienceName","remoteFullPackageName","credentialMetadata","platform","localKeystorePath","resolve","localKeystoreExists","existsSync","warn","red","questions","type","name","message","answers","confirm","removeCredentialsForPlatform","credentialsExistForPlatformAsync","credentials","checkEnv","collectAndValidateCredentialsFromCI","options","clearCredentials","console","log","choices","value","validate","keystorePath","stat","keystorePathStats","isFile","filter","isAbsolute","when","uploadKeystore","val","password","_clearCredentials","keystoreAlias","keystorePassword","keyPassword","readFile","keystoreData","keystore","toString","updateCredentialsForPlatform","process","env","EXPO_ANDROID_KEYSTORE_PASSWORD","EXPO_ANDROID_KEY_PASSWORD","sdkVersion","checkIfSdkIsSupported"],"mappings":"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","file":"../../../commands/build/AndroidBuilder.js","sourcesContent":["/**\n * @flow\n */\n\nimport fs from 'fs-extra';\nimport path from 'path';\nimport untildify from 'untildify';\nimport { Exp, Credentials } from 'xdl';\nimport chalk from 'chalk';\nimport log from '../../log';\n\nimport BaseBuilder from './BaseBuilder';\nimport prompt from '../../prompt';\n\nexport default class AndroidBuilder extends BaseBuilder {\n  async run() {\n    // Check the status of any current builds\n    await this.checkStatus();\n    // Validate project\n    await this.validateProject();\n    // Check for existing credentials, collect any missing credentials, and validate them\n    await this.collectAndValidateCredentials();\n    // Publish the current experience, if necessary\n    const publishedExpIds = await this.ensureReleaseExists('android');\n    // Initiate a build\n    await this.build(publishedExpIds, 'android');\n  }\n\n  async _clearCredentials() {\n    const {\n      args: { username, remotePackageName, remoteFullPackageName: experienceName },\n    } = await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    const localKeystorePath = path.resolve(`${remotePackageName}.jks`);\n    const localKeystoreExists = fs.existsSync(localKeystorePath);\n    if (localKeystoreExists) {\n      log.warn(\n        'Detected a local copy of an Android keystore. Please double check that the keystore is up to date so it can be used as a backup.'\n      );\n    } else {\n      log.warn('Cannot find a local keystore in the current project directory.');\n      log.warn('Can you make sure you have a local backup of your keystore?');\n      log.warn(\n        'You can fetch an updated version from our servers by using `exp fetch:android:keystore [project-dir]`'\n      );\n    }\n    log.warn(\n      `Clearing your Android build credentials from our build servers is a ${chalk.red(\n        'PERMANENT and IRREVERSIBLE action.'\n      )}`\n    );\n    log.warn(\n      'Android keystores must be identical to the one previously used to submit your app to the Google Play Store.'\n    );\n    log.warn(\n      'Please read https://docs.expo.io/versions/latest/guides/building-standalone-apps.html#if-you-choose-to-build-for-android for more info before proceeding.'\n    );\n    let questions = [\n      {\n        type: 'confirm',\n        name: 'confirm',\n        message: 'Permanently delete the Android build credentials from our servers?',\n      },\n    ];\n\n    const answers = await prompt(questions);\n\n    if (answers.confirm) {\n      await Credentials.removeCredentialsForPlatform('android', credentialMetadata);\n    }\n  }\n\n  async collectAndValidateCredentials() {\n    const {\n      args: { username, remoteFullPackageName: experienceName },\n    } = await Exp.getPublishInfoAsync(this.projectDir);\n\n    const credentialMetadata = {\n      username,\n      experienceName,\n      platform: 'android',\n    };\n\n    const credentials = await Credentials.credentialsExistForPlatformAsync(credentialMetadata);\n\n    if (this.checkEnv()) {\n      await this.collectAndValidateCredentialsFromCI(credentialMetadata);\n    } else if (this.options.clearCredentials || !credentials) {\n      console.log('');\n      const questions = [\n        {\n          type: 'rawlist',\n          name: 'uploadKeystore',\n          message: `Would you like to upload a keystore or have us generate one for you?\\nIf you don't know what this means, let us handle it! :)\\n`,\n          choices: [\n            { name: 'Let Expo handle the process!', value: false },\n            { name: 'I want to upload my own keystore!', value: true },\n          ],\n        },\n        {\n          type: 'input',\n          name: 'keystorePath',\n          message: `Path to keystore:`,\n          validate: async keystorePath => {\n            try {\n              const keystorePathStats = await fs.stat(keystorePath);\n              return keystorePathStats.isFile();\n            } catch (e) {\n              // file does not exist\n              console.log('\\nFile does not exist.');\n              return false;\n            }\n          },\n          filter: keystorePath => {\n            keystorePath = untildify(keystorePath);\n            if (!path.isAbsolute(keystorePath)) {\n              keystorePath = path.resolve(keystorePath);\n            }\n            return keystorePath;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'input',\n          name: 'keystoreAlias',\n          message: `Keystore Alias:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keystorePassword',\n          message: `Keystore Password:`,\n          validate: val => val !== '',\n          when: answers => answers.uploadKeystore,\n        },\n        {\n          type: 'password',\n          name: 'keyPassword',\n          message: `Key Password:`,\n          validate: (password, answers) => {\n            if (password === '') {\n              return false;\n            }\n            // Todo validate keystore passwords\n            return true;\n          },\n          when: answers => answers.uploadKeystore,\n        },\n      ];\n\n      const answers = await prompt(questions);\n\n      if (!answers.uploadKeystore) {\n        if (this.options.clearCredentials) {\n          await this._clearCredentials();\n        }\n        // just continue\n      } else {\n        const { keystorePath, keystoreAlias, keystorePassword, keyPassword } = answers;\n\n        // read the keystore\n        const keystoreData = await fs.readFile(keystorePath);\n\n        const credentials = {\n          keystore: keystoreData.toString('base64'),\n          keystoreAlias,\n          keystorePassword,\n          keyPassword,\n        };\n        await Credentials.updateCredentialsForPlatform('android', credentials, credentialMetadata);\n      }\n    }\n  }\n\n  checkEnv() {\n    return (\n      this.options.keystorePath &&\n      this.options.keystoreAlias &&\n      process.env.EXPO_ANDROID_KEYSTORE_PASSWORD &&\n      process.env.EXPO_ANDROID_KEY_PASSWORD\n    );\n  }\n\n  async collectAndValidateCredentialsFromCI(credentialMetadata) {\n    const credentials = {\n      keystore: (await fs.readFile(this.options.keystorePath)).toString('base64'),\n      keystoreAlias: this.options.keystoreAlias,\n      keystorePassword: process.env.EXPO_ANDROID_KEYSTORE_PASSWORD,\n      keyPassword: process.env.EXPO_ANDROID_KEY_PASSWORD,\n    };\n    await Credentials.updateCredentialsForPlatform('android', credentials, credentialMetadata);\n  }\n\n  async validateProject() {\n    const { args: { sdkVersion } } = await Exp.getPublishInfoAsync(this.projectDir);\n    await this.checkIfSdkIsSupported(sdkVersion, 'android');\n  }\n}\n"],"sourceRoot":"/exp@54.0.1/src"}